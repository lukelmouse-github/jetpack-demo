package com.example.demo.view;

/**
 * TextViewæºç åˆ†æï¼šä¸ºä»€ä¹ˆåŒæ—¶è°ƒç”¨requestLayout()å’Œinvalidate()
 * æ·±å…¥è§£æAndroid Viewç³»ç»Ÿçš„ç»†èŠ‚æœºåˆ¶
 */
public class TextViewSourceAnalysis {

    /*
    ===============================================================
    ğŸ¯ æ ¸å¿ƒé—®é¢˜ï¼šä¸ºä»€ä¹ˆTextViewåŒæ—¶è°ƒç”¨ä¸¤ä¸ªæ–¹æ³•ï¼Ÿ
    ===============================================================
    
    TextView.setText()æºç ä¸­çš„å…³é”®è°ƒç”¨ï¼š
    
    private void setText(CharSequence text, BufferType type, boolean notifyBefore, int oldlen) {
        // ... è®¾ç½®æ–‡å­—å†…å®¹ ...
        
        if (mLayout != null) {
            checkForRelayout(); // ğŸ”¥ è¿™é‡Œä¼šè°ƒç”¨requestLayout()
        }
        
        if (hasPasswordTransformationMethod()) {
            invalidate(); // ğŸ”¥ åŒæ—¶è°ƒç”¨invalidate()
        }
        
        // æˆ–è€…åœ¨å…¶ä»–æƒ…å†µä¸‹
        requestLayout();  // ğŸ”¥ å¤„ç†å°ºå¯¸å˜åŒ–
        invalidate();     // ğŸ”¥ ç¡®ä¿å†…å®¹é‡ç»˜
    }
    
    ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªï¼Ÿè®©æˆ‘ä»¬åˆ†æå…·ä½“åœºæ™¯...
    
    */

    /*
    ===============================================================
    ğŸ“Š åœºæ™¯åˆ†æï¼šrequestLayout()çš„drawæ‰§è¡Œæ¡ä»¶
    ===============================================================
    
    åœºæ™¯1ï¼šæ–‡å­—å˜é•¿ï¼Œå°ºå¯¸æ”¹å˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ TextView.setText("å¾ˆé•¿çš„æ–‡å­—å†…å®¹...")      â”‚
    â”‚ â”œâ”€ requestLayout()                      â”‚
    â”‚ â”‚  â”œâ”€ onMeasure() â†’ æ–°å°ºå¯¸ 400x60       â”‚
    â”‚ â”‚  â”œâ”€ onLayout() â†’ ä½ç½®å¯èƒ½å˜åŒ–          â”‚
    â”‚ â”‚  â””â”€ onDraw() âœ… å°ºå¯¸å˜äº†,è‡ªåŠ¨é‡ç»˜     â”‚
    â”‚ â””â”€ invalidate() â†’ å¤šä½™ä½†æ— å®³             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    åœºæ™¯2ï¼šæ–‡å­—å†…å®¹å˜åŒ–ï¼Œå°ºå¯¸ä¸å˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ TextView.setText("ABC" â†’ "XYZ")         â”‚
    â”‚ â”œâ”€ requestLayout()                      â”‚
    â”‚ â”‚  â”œâ”€ onMeasure() â†’ ç›¸åŒå°ºå¯¸ 100x40     â”‚
    â”‚ â”‚  â”œâ”€ onLayout() â†’ ç›¸åŒä½ç½®              â”‚
    â”‚ â”‚  â””â”€ onDraw() âŒ å°ºå¯¸æ²¡å˜,å¯èƒ½è·³è¿‡!    â”‚
    â”‚ â””â”€ invalidate() âœ… ç¡®ä¿å†…å®¹é‡ç»˜         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    åœºæ™¯3ï¼šwrap_contentä½†å†…å®¹å˜çŸ­
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ TextView.setText("Long" â†’ "Hi")         â”‚
    â”‚ â”œâ”€ requestLayout()                      â”‚
    â”‚ â”‚  â”œâ”€ onMeasure() â†’ æ›´å°å°ºå¯¸ 50x40      â”‚
    â”‚ â”‚  â”œâ”€ onLayout() â†’ ä½ç½®å¯èƒ½å˜åŒ–          â”‚
    â”‚ â”‚  â””â”€ onDraw() âœ… å°ºå¯¸å˜äº†,è‡ªåŠ¨é‡ç»˜     â”‚
    â”‚ â””â”€ invalidate() â†’ åŒä¿é™©                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    */

    /*
    ===============================================================
    ğŸ”¬ ViewRootImpl.performTraversals()è¯¦ç»†é€»è¾‘
    ===============================================================
    
    // Androidæºç ä¸­çš„å…³é”®åˆ¤æ–­é€»è¾‘
    private void performTraversals() {
        
        boolean layoutRequested = mLayoutRequested && (!mStopped || mReportNextDraw);
        boolean windowShouldResize = layoutRequested && windowSizeMayChange;
        
        // ğŸ”„ æ‰§è¡Œæµ‹é‡å’Œå¸ƒå±€
        if (layoutRequested) {
            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);
            performLayout(lp, mWidth, mHeight);
        }
        
        // ğŸ¨ ç»˜åˆ¶æ‰§è¡Œæ¡ä»¶åˆ¤æ–­
        boolean triggerGlobalLayoutListener = layoutRequested;
        boolean canDrawNow = true;
        
        // ğŸ”¥ å…³é”®åˆ¤æ–­ï¼šä»€ä¹ˆæ—¶å€™éœ€è¦é‡ç»˜ï¼Ÿ
        if (layoutRequested) {
            // æ£€æŸ¥Viewæ ‘æ˜¯å¦çœŸçš„å‘ç”Ÿäº†å˜åŒ–
            if (mFirst || windowShouldResize || insetsChanged || 
                viewVisibilityChanged || params != null) {
                mFullRedrawNeeded = true; // éœ€è¦å®Œæ•´é‡ç»˜
            }
        }
        
        // ğŸ”¥ åªæœ‰æ»¡è¶³æ¡ä»¶æ‰æ‰§è¡Œç»˜åˆ¶
        if (!mStopped && (mFullRedrawNeeded || newSurface)) {
            performDraw(); // è¿™é‡Œæ‰çœŸæ­£ç»˜åˆ¶
        }
    }
    
    å…³é”®é—®é¢˜ï¼šå¦‚æœViewçš„å°ºå¯¸æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œ
    requestLayout()å¯èƒ½ä¸ä¼šè§¦å‘onDraw()ï¼
    
    */

    /*
    ===============================================================
    ğŸ¯ TextViewå…·ä½“æºç åˆ†æ
    ===============================================================
    
    // TextView.checkForRelayout()æ–¹æ³•
    private void checkForRelayout() {
        if ((mLayoutParams.width != LayoutParams.WRAP_CONTENT ||
             (mMaxWidthMode == mMinWidthMode && mMaxWidth == mMinWidth)) &&
             (mHint == null || mHintLayout != null) &&
             (mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight() > 0)) {
                 
            // ğŸ”¥ æƒ…å†µ1ï¼šå›ºå®šå®½åº¦ï¼Œåªéœ€è¦æ£€æŸ¥é«˜åº¦
            int oldht = mLayout.getHeight();
            makeNewLayout(want, hintWant, UNKNOWN_BORING, UNKNOWN_BORING, 
                         mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight(), 
                         false);
                         
            // é«˜åº¦å˜åŒ–äº†æ‰requestLayout
            if (mLayout.getHeight() != oldht) {
                requestLayout();
                invalidate(); // ğŸ”¥ åŒæ—¶è°ƒç”¨ç¡®ä¿é‡ç»˜
            }
        } else {
            // ğŸ”¥ æƒ…å†µ2ï¼šwrap_contentï¼Œå¯èƒ½éœ€è¦é‡æ–°æµ‹é‡
            nullLayouts();
            requestLayout();  // ğŸ”¥ å¯èƒ½æ”¹å˜å°ºå¯¸
            invalidate();     // ğŸ”¥ ç¡®ä¿å†…å®¹æ›´æ–°
        }
    }
    
    */

    /*
    ===============================================================
    âš¡ å®é™…æµ‹è¯•éªŒè¯
    ===============================================================
    
    æµ‹è¯•åœºæ™¯ï¼šTextViewå›ºå®šå°ºå¯¸ï¼Œåªæ”¹å˜æ–‡å­—å†…å®¹
    
    // æµ‹è¯•ä»£ç 
    TextView textView = findViewById(R.id.textView);
    textView.setWidth(200); // å›ºå®šå®½åº¦
    textView.setHeight(60); // å›ºå®šé«˜åº¦
    
    // æƒ…å†µAï¼šåªè°ƒç”¨requestLayout()
    textView.setText("New Text");
    textView.requestLayout(); // å¯èƒ½ä¸ä¼šé‡ç»˜å†…å®¹ï¼
    
    // æƒ…å†µBï¼šåªè°ƒç”¨invalidate()  
    textView.setText("New Text");
    textView.invalidate(); // å†…å®¹æ›´æ–°ä½†å¯èƒ½ä½ç½®ä¸å¯¹
    
    // æƒ…å†µCï¼šåŒæ—¶è°ƒç”¨ï¼ˆTextViewçš„åšæ³•ï¼‰
    textView.setText("New Text");
    textView.requestLayout(); // å¤„ç†å¯èƒ½çš„å°ºå¯¸å˜åŒ–
    textView.invalidate();    // ç¡®ä¿å†…å®¹é‡ç»˜
    
    ç»“æœï¼šåªæœ‰æƒ…å†µCèƒ½ä¿è¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ­£ç¡®æ˜¾ç¤ºï¼
    
    */

    /*
    ===============================================================
    ğŸ›¡ï¸ é˜²å¾¡æ€§ç¼–ç¨‹çš„è€ƒè™‘
    ===============================================================
    
    TextViewåŒæ—¶è°ƒç”¨ä¸¤ä¸ªæ–¹æ³•çš„åŸå› ï¼š
    
    1. ğŸ¯ è¦†ç›–æ‰€æœ‰æƒ…å†µï¼š
       â€¢ requestLayout()å¤„ç†å°ºå¯¸å¯èƒ½å˜åŒ–çš„æƒ…å†µ
       â€¢ invalidate()ç¡®ä¿å†…å®¹ä¸€å®šä¼šé‡ç»˜
    
    2. ğŸš€ æ€§èƒ½vså®‰å…¨æ€§çš„æƒè¡¡ï¼š
       â€¢ å¤šè°ƒç”¨ä¸€æ¬¡invalidate()çš„å¼€é”€å¾ˆå°
       â€¢ ä½†èƒ½é¿å…UIæ˜¾ç¤ºé”™è¯¯çš„ä¸¥é‡é—®é¢˜
    
    3. ğŸ”„ ç³»ç»Ÿå¤æ‚æ€§ï¼š
       â€¢ Androidè®¾å¤‡ä¼—å¤šï¼ŒROMå®šåˆ¶å„å¼‚
       â€¢ é˜²å¾¡æ€§ç¼–ç¨‹ç¡®ä¿å…¼å®¹æ€§
    
    4. ğŸ“± ç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼š
       â€¢ å®å¯å¤šæ‰§è¡Œä¸€æ¬¡ç»˜åˆ¶
       â€¢ ä¹Ÿä¸èƒ½è®©ç”¨æˆ·çœ‹åˆ°é”™è¯¯çš„å†…å®¹
    
    */

    /*
    ===============================================================
    ğŸ’¡ æœ€ä½³å®è·µå»ºè®®
    ===============================================================
    
    å¯¹äºå¼€å‘è€…ï¼š
    
    1. âœ… ç†è§£åŸç†ï¼ŒæŒ‰éœ€ä½¿ç”¨ï¼š
       // åªæ”¹å˜å¤–è§‚
       view.setBackgroundColor(Color.RED);
       view.invalidate(); // åªéœ€invalidate
       
       // æ”¹å˜å°ºå¯¸
       ViewGroup.LayoutParams params = view.getLayoutParams();
       params.width = newWidth;
       view.setLayoutParams(params); // å†…éƒ¨ä¼šè°ƒç”¨requestLayout
       
       // å¤æ‚å˜åŒ–ï¼ˆä¸ç¡®å®šæ˜¯å¦å½±å“å°ºå¯¸ï¼‰
       customView.setComplexData(data);
       customView.requestLayout(); // å¤„ç†å¯èƒ½çš„å°ºå¯¸å˜åŒ–
       customView.invalidate();    // ç¡®ä¿å†…å®¹æ›´æ–°
    
    2. ğŸ¯ è‡ªå®šä¹‰Viewçš„å»ºè®®ï¼š
       â€¢ æ˜ç¡®çŸ¥é“åªå½±å“å¤–è§‚ï¼šåªç”¨invalidate()
       â€¢ æ˜ç¡®çŸ¥é“å½±å“å°ºå¯¸ï¼šåªç”¨requestLayout()
       â€¢ ä¸ç¡®å®šæˆ–å¤æ‚æƒ…å†µï¼šåŒæ—¶ä½¿ç”¨ï¼ˆå­¦ä¹ TextViewï¼‰
    
    3. âš¡ æ€§èƒ½è€ƒè™‘ï¼š
       â€¢ invalidate()å¾ˆè½»é‡ï¼Œå¤šè°ƒç”¨ä¸€æ¬¡æ— å®³
       â€¢ requestLayout()è¾ƒé‡ï¼Œä¸è¦æ»¥ç”¨
       â€¢ æ‰¹é‡æ›´æ–°æ—¶åœ¨æœ€åç»Ÿä¸€è°ƒç”¨
    
    */

    /*
    ===============================================================
    ğŸ“‹ æ€»ç»“
    ===============================================================
    
    TextViewåŒæ—¶è°ƒç”¨requestLayout()å’Œinvalidate()çš„åŸå› ï¼š
    
    ğŸ”¥ æ ¸å¿ƒåŸå› ï¼š
    â€¢ requestLayout()çš„drawé˜¶æ®µæœ‰æ‰§è¡Œæ¡ä»¶
    â€¢ å½“å°ºå¯¸æ²¡å˜æ—¶ï¼Œå¯èƒ½ä¸ä¼šé‡ç»˜å†…å®¹
    â€¢ invalidate()ç¡®ä¿å†…å®¹ä¸€å®šä¼šæ›´æ–°
    
    ğŸ›¡ï¸ è®¾è®¡ç†å¿µï¼š
    â€¢ é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œç¡®ä¿æ‰€æœ‰æƒ…å†µéƒ½æ­£ç¡®
    â€¢ ç”¨æˆ·ä½“éªŒä¼˜å…ˆäºæ€§èƒ½å¾®ä¼˜åŒ–
    â€¢ ç³»ç»Ÿç»„ä»¶éœ€è¦æé«˜çš„ç¨³å®šæ€§
    
    ğŸ’¡ å¯ç¤ºï¼š
    â€¢ ç†è§£Androidç³»ç»Ÿçš„å¤æ‚æ€§å’Œç»†è‡´è€ƒè™‘
    â€¢ åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸­ä¹Ÿåº”è¯¥è€ƒè™‘è¾¹ç•Œæƒ…å†µ
    â€¢ ç®€å•çš„APIèƒŒåå¾€å¾€æœ‰å¤æ‚çš„å®ç°é€»è¾‘
    
    è¿™å°±æ˜¯ä¸ºä»€ä¹ˆAndroidç³»ç»Ÿå¦‚æ­¤ç¨³å®šçš„åŸå› ä¹‹ä¸€ï¼
    
    */
}